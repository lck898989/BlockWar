{"version":3,"sources":["..\\..\\..\\..\\assets\\Scripts/assets\\Scripts\\ImageLoader.js"],"names":["md","require","cc","Class","extends","Component","statics","loadImage","url","callback","loader","load","err","tex","spriteFrame","SpriteFrame","Rect","width","height","filePath","rivalFilePath","rivalImageForWechatGame","self","wxDownloadImage","imageLoadToolForWechatGame","console","log","imagePath","tag","CC_WECHATGAME","error","wx","downloadFile","header","success","res","tempFilePath","statusCode","jpgPath","lastIndexOf","jpgName","slice","fileManager","getFileSystemManager","localPath","env","USER_DATA_PATH","Promise","resolve","reject","saveFile","savedFilePath","fail","then","complete","imageLoadTool","dirpath","jsb","fileUtils","getWritablePath","md5URL","filepath","loadEnd","retain","isFileExist","data","isDirectoryExist","createDirectory","writeDataToFile","Uint8Array","xhr","XMLHttpRequest","onreadystatechange","readyState","status","response","bind","responseType","open","send"],"mappings":"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","file":"ImageLoader.js","sourceRoot":"..\\..\\..\\..\\assets\\Scripts","sourcesContent":["/*\r\n * @Author: mikey.zhaopeng \r\n * @Date: 2018-07-12 19:47:53 \r\n * @Last Modified by: mikey.zhaopeng\r\n * @Last Modified time: 2018-08-09 16:40:48\r\n */\r\n/**\r\n * 远程加载图片到本地，供以后使用\r\n */\r\n\r\nvar md = require(\"./md5\");\r\ncc.Class({\r\n    extends: cc.Component,\r\n    statics : {\r\n        loadImage : function (url,callback){\r\n            cc.loader.load(url,function (err,tex) {\r\n                var spriteFrame = new cc.SpriteFrame(tex, cc.Rect(0, 0, tex.width, tex.height));\r\n                callback(spriteFrame);\r\n            });\r\n        },\r\n        //自己的头像地址\r\n        filePath : \"\",\r\n        //敌人的图片的地址路径\r\n        rivalFilePath : \"\",\r\n        //敌人图片的路径保存到本地\r\n        rivalImageForWechatGame : function(url,callback){\r\n            var self = this;\r\n            this.wxDownloadImage(self.rivalFilePath,url,callback,\"rival\");\r\n        },\r\n        //微信小游戏保存图片到本地\r\n        imageLoadToolForWechatGame(url,callback){\r\n            var self = this;\r\n            console.log(\"self.filePath is \",self.filePath);\r\n            //下载图片\r\n            this.wxDownloadImage(self.filePath,url,callback,\"self\");\r\n        },\r\n        /**\r\n         * @param  {保存到本地的图片地址} imagePath\r\n         * @param  {远程图片的地址url} url\r\n         * @param  {回调函数将spriteFrame返回出去} callback\r\n         * @param  {是对手请求图片还是自己请求图片} tag\r\n         */\r\n        wxDownloadImage : function(imagePath,url,callback,tag){\r\n            var self = this;\r\n            if(CC_WECHATGAME){\r\n                console.log(\"imagePath is \",imagePath);\r\n                // var self = this;\r\n                // var localPath = wx.env.USER_DATA_PATH + '/';\r\n                if(imagePath !== \"\"){\r\n                    // var fileManager = wx.getFileSystemManager();\r\n                    // //从路径里面取图片\r\n                    // var imageData = fileManager.readFileSync(imagePath);\r\n                    // var jpgPath = imagePath.lastIndexOf('/');\r\n                    // var jpgName = imagePath.slice(jpgPath);\r\n                    // var localPath = wx.env.USER_DATA_PATH + '/' + jpgName;\r\n                    // var urlX = \r\n                    console.log(\"用户的头像已经存在在本地\");\r\n                    cc.loader.load(imagePath, function(err, tex){\r\n                        if( err ){\r\n                            cc.error(err);\r\n                        }else{\r\n                            var spriteFrame = new cc.SpriteFrame(tex);\r\n                            if( spriteFrame ){\r\n                                callback(spriteFrame);\r\n                            }\r\n                        }\r\n                    });\r\n                }else{\r\n                    wx.downloadFile({\r\n                        url : url,\r\n                        header : {\r\n                            \"content-type\":\"image/jpeg\"\r\n                        },\r\n                        success : function(res){\r\n                            console.log(\"tempFilePath is \",res.tempFilePath);\r\n                            console.log(\"响应消息 is \",res.statusCode);\r\n                            var tempFilePath = res.tempFilePath;\r\n                            console.log(\"tempFilePath is \",tempFilePath);\r\n                            var jpgPath = tempFilePath.lastIndexOf('/');\r\n                            var jpgName = tempFilePath.slice(jpgPath);\r\n                            // wx.saveImageToPhotosAlbum({\r\n                            //     filePath : tempFilePath,\r\n                            //     success  : function(res){\r\n                            //         console.log(\"图片保存到系统相册\",res);\r\n                            //     }\r\n                            // });\r\n                            var fileManager = wx.getFileSystemManager();\r\n                            var localPath = wx.env.USER_DATA_PATH + '/' + jpgName;\r\n                            new Promise(function(resolve,reject){\r\n                                fileManager.saveFile({\r\n                                    tempFilePath : tempFilePath,\r\n                                    filePath     : localPath,\r\n                                    success : function(res){\r\n                                        console.log(\"savedFilePath is \",res.savedFilePath);\r\n                                        //图片地址\r\n                                        if(tag === \"self\"){\r\n                                            self.filePath = res.savedFilePath;\r\n                                        }else if(tag === 'rival'){\r\n                                            self.rivalFilePath = res.savedFilePath;\r\n                                        }\r\n                                        // imagePath = res.savedFilePath;\r\n                                        resolve(res.savedFilePath);\r\n                                    },\r\n                                    fail : function(){\r\n                                        console.log(\"文件保存失败！！\");\r\n                                    }\r\n                                });\r\n                            }).then(function(filePath){\r\n                                //保存完相册完毕之后取出来\r\n                                cc.loader.load(filePath, function(err, tex){\r\n                                    if( err ){\r\n                                        cc.error(err);\r\n                                    }else{\r\n                                        var spriteFrame = new cc.SpriteFrame(tex);\r\n                                        if( spriteFrame ){\r\n                                            callback(spriteFrame);\r\n                                        }\r\n                                    }\r\n                                });\r\n                            });\r\n                        },\r\n                        fail :function(){\r\n                            console.log(\"下载文件失败\");\r\n                        },\r\n                        complete : function(){\r\n    \r\n                        }\r\n                    });\r\n                }\r\n                \r\n            }\r\n        },\r\n        imageLoadTool(url, callback){\r\n            var dirpath =  jsb.fileUtils.getWritablePath() + 'customHeadImage/';\r\n            console.log(\"dirpath ->\",dirpath);\r\n            //对路径url进行加密\r\n            let md5URL = md(url);\r\n            var filepath = dirpath + md5URL + '.jpg';\r\n            console.log(\"filepath ->\",filepath);\r\n            function loadEnd(){\r\n                cc.loader.load(filepath, function(err, tex){\r\n                    if( err ){\r\n                        cc.error(err);\r\n                    }else{\r\n                        var spriteFrame = new cc.SpriteFrame(tex);\r\n                        if( spriteFrame ){\r\n                            spriteFrame.retain();\r\n                            callback(spriteFrame);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n            if( jsb.fileUtils.isFileExist(filepath) ){\r\n                cc.log('Remote is find' + filepath);\r\n                loadEnd();\r\n                return;\r\n            }\r\n            var saveFile = function(data){\r\n                if( typeof data !== 'undefined' ){\r\n                    if(!jsb.fileUtils.isDirectoryExist(dirpath)){\r\n                        jsb.fileUtils.createDirectory(dirpath);\r\n                    }else{\r\n                        console.log(\"路径exist\");\r\n                    }\r\n                    // new Uint8Array(data) writeDataToFile  writeStringToFile\r\n                    if( jsb.fileUtils.writeDataToFile( new Uint8Array(data) , filepath) ){\r\n                        cc.log('Remote write file succeed.');\r\n                        loadEnd();\r\n                    }else{\r\n                        cc.log('Remote write file failed.');\r\n                    }\r\n                }else{\r\n                    cc.log('Remote download file failed.');\r\n                }\r\n            };\r\n            var xhr = new XMLHttpRequest();\r\n            xhr.onreadystatechange = function () {\r\n                cc.log(\"xhr.readyState  \" +xhr.readyState);\r\n                cc.log(\"xhr.status  \" +xhr.status);\r\n                if (xhr.readyState === 4 ) {\r\n                    if(xhr.status === 200){\r\n                        //responseType一定要在外面设置\r\n                        // xhr.responseType = 'arraybuffer'; \r\n                        saveFile(xhr.response);\r\n                    }else{\r\n                        saveFile(null);\r\n                    }\r\n                }\r\n            }.bind(this);\r\n            //responseType一定要在外面设置\r\n            xhr.responseType = 'arraybuffer';\r\n            xhr.open(\"GET\", url, true);\r\n            xhr.send();\r\n        },\r\n    },\r\n});"]}