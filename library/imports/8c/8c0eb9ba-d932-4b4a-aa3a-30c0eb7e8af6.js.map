{"version":3,"sources":["..\\..\\..\\..\\assets\\Scripts/assets\\Scripts\\WechatLogin.js"],"names":["cc","Class","extends","Component","properties","waitServer","Node","clickAudio","url","AudioClip","default","startBtn","onLoad","accessToken","openId","refshToken","fTokenTime","isTokenTime","screenAdapt","wxLoginSuccess","WechatLogin","CC_WECHATGAME","wx","showLoading","title","mask","current","audioEngine","play","sys","isNative","console","log","director","loadScene","active","self","checkSession","success","wechatGameLogin","fail","complete","login","code","appid","secret","request","data","header","method","dataType","res","sessionKey","getUserInfo","userInfo","nickName","find","getComponent","nameUser","pictureUser","avatarUrl","result","GetServerMsg","GetAccessToken","code1","xhr","XMLHttpRequest","onreadystatechange","readyState","status","response","responseText","SendServer","msg","JSON","parse","access_token","openid","refresh_token","open","send","str","str1","msg1","GetUserMsg","msg2","nickname","headimgurl","SendUserInfo","stringify","RefreshToken","isRefsh","start","size","view","getFrameSize","size1","getWinSize","width","height","update","dt","opacity"],"mappings":"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","file":"WechatLogin.js","sourceRoot":"..\\..\\..\\..\\assets\\Scripts","sourcesContent":["// Learn cc.Class:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\r\n// Learn Attribute:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        // foo: {\r\n        //     // ATTRIBUTES:\r\n        //     default: null,        // The default value will be used only when the component attaching\r\n        //                           // to a node for the first time\r\n        //     type: cc.SpriteFrame, // optional, default is typeof default\r\n        //     serializable: true,   // optional, default is true\r\n        // },\r\n        // bar: {\r\n        //     get () {\r\n        //         return this._bar;\r\n        //     },\r\n        //     set (value) {\r\n        //         this._bar = value;\r\n        //     }\r\n        // },\r\n        waitServer : cc.Node,\r\n        clickAudio : {\r\n            url     : cc.AudioClip,\r\n            default : null,\r\n        },\r\n        startBtn : cc.Node,\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    onLoad () {\r\n        \r\n        //初始化用code获取的accesstoken\r\n        this.accessToken=\"\";\r\n        //初始化用code获取的openid\r\n        this.openId=\"\";\r\n        //初始化用code获取的refeshtoken\r\n        this.refshToken=\"\";\r\n\r\n        //初始化accessToken计时器\r\n        this.fTokenTime=0;\r\n          //初始化accessToken计时开关\r\n        this.isTokenTime=false;\r\n        // this.waitServer.active = false;\r\n        //    //初始化是否刷新refsh\r\n        //    this.isRefsh=false;\r\n        // this.is=false;\r\n        this.screenAdapt();\r\n        this.wxLoginSuccess = false;\r\n    },\r\n   //微信登陆i\r\n   WechatLogin:function(){\r\n    if(CC_WECHATGAME){\r\n        //显示加载中提升用户体验\r\n        wx.showLoading({\r\n            title : '获取用户信息...',\r\n            mask  : true,\r\n        });\r\n    }\r\n    //播放背景音乐\r\n    this.current = cc.audioEngine.play(this.clickAudio,false,1);\r\n    if(cc.sys.isNative){\r\n        console.log(\"登录方法进入原环境\");\r\n        // jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"wxLogin\",\"()V\");\r\n        cc.director.loadScene(\"Main\");\r\n    }else{\r\n        //进入微信小游戏开发环境\r\n        if(CC_WECHATGAME){\r\n            this.waitServer.active = true;\r\n            console.log(\"进入微信小游戏开发平台\");\r\n            var self = this;\r\n            wx.checkSession({\r\n                success :function(){\r\n                    console.log(\"登录信息没有过期\");\r\n                    self.wechatGameLogin();\r\n                },\r\n                fail : function(){\r\n                    //session_key失效之后再重新登录\r\n                    console.log(\"微信登录已经过期重新登录微信\");\r\n                    self.wechatGameLogin();\r\n                },\r\n                complete : function(){\r\n                }\r\n            });\r\n            \r\n        } else {\r\n            cc.director.loadScene(\"Main\");\r\n        }\r\n    }\r\n    \r\n    },\r\n    //微信小游戏微信登录方法\r\n    wechatGameLogin :function(){\r\n        var self = this;\r\n        wx.login({\r\n            success : function(code){\r\n                console.log(\"code is \",code);\r\n                code.appid  = \"wx659abd0e802de13a\";\r\n                code.secret = \"49cc1d1dd2fac12d4aa622eebe403605\";\r\n                if(code != null){\r\n                    //发起微信请求\r\n                    wx.request({\r\n                        url         : \"https://m5.ykplay.com/LoginCode\",\r\n                        data        :  code,\r\n                        header      : {\r\n\r\n                        },\r\n                        method      : \"POST\",\r\n                        dataType    : \"json\",\r\n                        success     : function(res){\r\n                            console.log(\"res is \",res);\r\n                            //获得session_key\r\n                            self.sessionKey = res.data;\r\n                            console.log(res.data);\r\n                            wx.getUserInfo({\r\n                                success : function(res){\r\n                                    console.log(\"res is \",res);\r\n                                    res.sessionKey = self.sessionKey.data;\r\n                                    //保存用户信息\r\n                                    console.log(\"在微信登录里面昵称是 :\"+res.userInfo.nickName);\r\n                                    cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").nameUser = res.userInfo.nickName;\r\n                                    console.log(\"用户名是：\",cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").nameUser);\r\n                                    //保存用户头像信息\r\n                                    cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").pictureUser = res.userInfo.avatarUrl;\r\n                                    wx.request({\r\n                                        url         : \"https://m5.ykplay.com/UserInfo\",\r\n                                        data        :  res,\r\n                                        header      : {\r\n            \r\n                                        },\r\n                                        method      : \"POST\",\r\n                                        dataType    : \"json\",\r\n                                        success     : function(result){\r\n                                            console.log(\"res is \",result);\r\n                                            cc.find(\"PebmanentNode\").getComponent(\"GetServer\").GetServerMsg(result.data);\r\n                                        },\r\n                                        fail        :function(res){\r\n                                            console.log(res);\r\n                                            console.log(\"userInfo request fail\");\r\n                                        },\r\n                                        complete    :function(){\r\n            \r\n                                        },\r\n                                    })\r\n                                }\r\n                            });\r\n                        },\r\n                        fail        :function(){\r\n                            console.log(\"fail\");\r\n                        },\r\n                        complete    :function(){\r\n\r\n                        },\r\n\r\n                    })\r\n                }\r\n                \r\n            },\r\n            fail : function(){\r\n\r\n            },\r\n            complete : function(){\r\n\r\n            },\r\n        });\r\n    },\r\n   //通过code获取微信accesstoken\r\n   GetAccessToken:function(code1){\r\n    console.log(\"in getAccessToken code1 is \" + code1);\r\n    var url = \"https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx72f9006d0b1d9b7f&secret=fe9036e8fdb8bc990a318227d0e68a5e&code=\"+code1+\"&grant_type=authorization_code\";\r\n    // var str = \"shop=钻石\";\r\n    // var str=\"name=1&password=1\";\r\n    var  self=this;\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.onreadystatechange = function () {\r\n        if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\r\n            console.log(\"微信相应\");\r\n            var response = xhr.responseText;     \r\n            console.log(\"in getAccessToken response is \" + response);\r\n            self.SendServer(response);\r\n            var msg=JSON.parse(response);\r\n            self.accessToken=msg.access_token;\r\n            self.openId=msg.openid; \r\n            self.refshToken=msg.refresh_token;\r\n        }\r\n    };\r\n\r\n    //    xhr.send(\"name=100\"+\"&password=1\");\r\n    xhr.open(\"GET\", url, true);\r\n     xhr.send();\r\n   },\r\n   //将获取到的accesstoken信息发给服务器\r\n\r\n   SendServer:function(str){\r\n    var url = \"https://m5.ykplay.com/login\";\r\n    var str1=\"{\\\"tag\\\":\\\"wxLogin\\\",\\\"body\\\":\"+str+\"}\";\r\n    var xhr = new XMLHttpRequest();\r\n    var self = this;\r\n    xhr.onreadystatechange = function () {\r\n        if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\r\n            console.log(\"相应信息。。。\");\r\n             var response = xhr.responseText;\r\n             console.log(\"response is \" + response);\r\n            var msg1=JSON.parse(response);\r\n            cc.find(\"PebmanentNode\").getComponent(\"GetServer\").GetServerMsg(msg1);\r\n        }\r\n    };\r\n    console.log(\"发送信息到服务器\")\r\n    xhr.open(\"POST\", url);\r\n    xhr.send(str1);\r\n   },\r\n   //登陆成功后访问微信获取用户信息\r\n   GetUserMsg:function(){\r\n    var url = \"https://api.weixin.qq.com/sns/userinfo?access_token=\"+this.accessToken+\"&openid=\"+this.openId;\r\n    // var str = \"shop=钻石\";\r\n    // var str=\"name=1&password=1\";\r\n    var  self=this;\r\n    self.isTokenTime=true;\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.onreadystatechange = function () {\r\n        if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\r\n              var response = xhr.responseText;\r\n              cc.log(response);\r\n              var msg2=JSON.parse(response);\r\n             cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").nameUser=msg2.nickname;\r\n             cc.log(msg2.headimgurl+\"\");\r\n            //  msg2.headimgurl=\"\";\r\n            //  if(msg2.headimgurl==\"\"||msg2.headimgurl==null||msg2.headimgurl==undefined)\r\n            //  {\r\n            //      cc.log(\"===================================\");\r\n                \r\n            //      cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").pictureUser=\"http://image.baidu.com/search/detail?ct=503316480&z=0&ipn=d&word=%E5%9B%BE%E7%89%87&hs=0&pn=7&spn=0&di=135898298690&pi=0&rn=1&tn=baiduimagedetail&is=0%2C0&ie=utf-8&oe=utf-8&cl=2&lm=-1&cs=2260926939%2C1550208231&os=2086677986%2C2932337668&simid=0%2C0&adpicid=0&lpn=0&ln=30&fr=ala&fm=&sme=&cg=&bdtype=0&oriquery=&objurl=http%3A%2F%2Fimg.zcool.cn%2Fcommunity%2F01690955496f930000019ae92f3a4e.jpg%402o.jpg&fromurl=ippr_z2C%24qAzdH3FAzdH3Fooo_z%26e3Bzv55s_z%26e3Bv54_z%26e3BvgAzdH3Fo56hAzdH3FZNTAaMzMy_z%26e3Bip4s%3FfotpviPw2j%3D5g&gsm=0&islist=&querylist=\";\r\n            //      self.SendUserInfo(JSON.stringify(msg2));\r\n            //  }\r\n            //  else\r\n            //  {\r\n            //     cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").pictureUser=msg2.headimgurl;\r\n            //     self.SendUserInfo(JSON.stringify(msg2));\r\n            //  }\r\n             cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").pictureUser=msg2.headimgurl;\r\n            //  //保存图片的texture2D到全局对象中\r\n            //  cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").userImage = cc.find(\"PebmanentNode\").getComponent(\"UserInfo\").getUserPicture(msg2.headimgurl);\r\n             self.SendUserInfo(JSON.stringify(msg2));\r\n        }\r\n    };\r\n    //    xhr.send(\"name=100\"+\"&password=1\");\r\n    xhr.open(\"GET\", url, true);\r\n     xhr.send();\r\n   },\r\n   //访问并新刷新accesstoken\r\n   RefreshToken:function(){\r\n     this.isRefsh=true;\r\n     var url = \"https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=wx72f9006d0b1d9b7f&grant_type=refresh_token&refresh_token=\"+this.refshToken;\r\n    // var str = \"shop=钻石\";\r\n    // var str=\"name=1&password=1\";\r\n    var  self=this;\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.onreadystatechange = function () {      \r\n        if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\r\n            var response = xhr.responseText;\r\n            self.SendServer(response);\r\n           var msg=JSON.parse(response);\r\n           self.accessToken=msg.access_token;\r\n           self.openId=msg.openid; \r\n           self.refshToken=msg.refresh_token;\r\n        }\r\n    };\r\n    //    xhr.send(\"name=100\"+\"&password=1\");\r\n    xhr.open(\"GET\", url, true);\r\n     xhr.send();\r\n   },\r\n   //将获取到的用户信息发给服务器\r\n   SendUserInfo:function(str){\r\n    var url = \"https://m5.ykplay.com/UserMsg\";\r\n    var str1=\"{\\\"tag\\\":\\\"UserMsg\\\",\"+\"\\\"type\\\":1,\"+\"\\\"body\\\":\"+str+\"}\";\r\n    var xhr = new XMLHttpRequest();\r\n    var self = this;\r\n    xhr.onreadystatechange = function () {\r\n        if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\r\n             var response = xhr.responseText;  \r\n            var msg1=JSON.parse(response);\r\n            //接受服务器用户并判断是否为非法用户\r\n            cc.find(\"PebmanentNode\").getComponent(\"GetServer\").GetServerMsg(msg1);\r\n        }\r\n    };\r\n    xhr.open(\"POST\", url);\r\n    xhr.send(str1);\r\n   },\r\n    start () {\r\n    },\r\n    //屏幕适配\r\n    screenAdapt : function(){\r\n        var size = cc.view.getFrameSize();\r\n        var size1 = cc.director.getWinSize();\r\n\r\n        console.log(\"设计分辨率的宽是\",size1.width);\r\n        console.log(\"设计分辨率的高是\",size1.height);\r\n        console.log(\"手机屏幕的宽是\",size.width);\r\n        console.log(\"手机屏幕的高是\",size.height);\r\n    },\r\n    update (dt) {\r\n        // if(this.isTokenTime)\r\n        // { \r\n        //     this.fTokenTime +=dt; \r\n        //     if(this.fTokenTime>7000)\r\n        //     {\r\n        //         this.RefreshToken();\r\n        //         this.isTokenTime=false;\r\n        //         this.fTokenTime=0;\r\n        //     }\r\n        // }\r\n        // if(!this.wxLoginSuccess){\r\n        //     if(cc.sys.isNative){\r\n        //         //判断用户微信是否登录\r\n        //         var loginState = jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"GetWeChatState\",\"()I\")\r\n        //         console.log(\"微信登录状态是\",loginState + typeof(loginState));\r\n        //         console.log(\"loginState === 1\",loginState === 1);\r\n        //         if(loginState === 1){\r\n        //             var code = jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"GetCode\",\"()Ljava/lang/String;\");\r\n        //             console.log(\"in update code is \",code);\r\n        //             this.GetAccessToken(code);\r\n        //             jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/AppActivity\",\"Init\",\"()V\");\r\n        //             this.wxLoginSuccess = true;\r\n        //         }\r\n        //     }\r\n        // }\r\n        // if(Global.wechatSuccess){\r\n        //     //显示等待节点\r\n        //     this.waitServer.active = true;\r\n        // }\r\n        // this.glinkTime += dt;\r\n        // if(this.glinkTime >= 1.5){\r\n\r\n        // }\r\n        if(this.startBtn.opacity > 100){\r\n            this.startBtn.opacity -= dt * 100;\r\n        }\r\n        if(this.startBtn.opacity <= 100){\r\n            this.startBtn.opacity = 255;\r\n        }\r\n        //登录成功之后设置开始游戏按钮透明度为255\r\n        // if(this.wxLoginSuccess){\r\n        //     this.startBtn.opacity = 255;\r\n        // }\r\n      \r\n    },\r\n});\r\n"]}